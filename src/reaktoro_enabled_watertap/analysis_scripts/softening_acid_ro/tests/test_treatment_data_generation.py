import pytest

from reaktoro_enabled_watertap.analysis_scripts.softening_acid_ro.data_generation import (
    treatment_sweep,
    validation_sweep,
    stability_sweep,
)
from reaktoro_enabled_watertap.utils.report_util import get_lib_path

from psPlotKit.data_manager.ps_data_manager import psDataManager

import os


@pytest.mark.component
def test_treatment_sweep():
    work_path = get_lib_path()
    filename = str(
        work_path
        / "analysis_scripts/softening_acid_ro/data_generation/output/treatment_lime_soda_ash_hcl_h2so4_sweep_analysisType_treatment_sweep.h5"
    )
    if os.path.exists(filename):
        os.remove(filename)

    treatment_sweep.main()

    data_manager = psDataManager(
        filename,
    )
    data_manager.register_data_key(
        file_key="fs.water_recovery", return_key="Water recovery", units="%"
    )
    data_manager.register_data_key(file_key="fs.costing.LCOW", return_key="LCOW")
    data_manager.load_data()
    data_manager.display()
    test_data = {
        (("water_sim_cases", "BGW"), "Water recovery"): [
            50.0,
            51.0,
            52.0,
            53.0,
            54.0,
            55.00000000000001,
            56.00000000000001,
            57.00000000000001,
            57.99999999999999,
            59.0,
            60.0,
            61.0,
            62.0,
            63.0,
            64.0,
            65.0,
            66.0,
            67.0,
            68.0,
            69.0,
            70.0,
            71.0,
            72.0,
            73.0,
            74.0,
            75.0,
            76.0,
            77.0,
            78.0,
            79.0,
            80.0,
            81.0,
            82.0,
            83.0,
            84.00000000000001,
            85.00000000000001,
            86.0,
            87.0,
            88.0,
            89.0,
            90.0,
        ],
        (("water_sim_cases", "BGW"), "LCOW"): [
            0.2156580962865019,
            0.21387009029098486,
            0.21216348483174272,
            0.21053477137681467,
            0.2089807471230017,
            0.2074984977525569,
            0.20609010363653318,
            0.2052136559812072,
            0.20557655932738234,
            0.2080027071762921,
            0.2137170875121642,
            0.2244291232667974,
            0.242504651308636,
            0.2634390826806359,
            0.3052568969857765,
            0.37412187090867427,
            0.4085557531125057,
            0.42799487939617037,
            0.4406452153958282,
            0.4507702996921865,
            0.45905341150311757,
            0.4659609149424136,
            0.4718528978847185,
            0.4770691609287608,
            0.48311607154524977,
            0.49522613994292386,
            0.5069541885724004,
            0.5176500865617573,
            0.5274380373316803,
            0.5364226984945342,
            0.5446938988874132,
            0.5523318112538624,
            0.5594105404819805,
            0.5660006481782034,
            0.572238375384632,
            0.5782733756081037,
            0.5842388887239114,
            0.590297201724645,
            0.5966561967130112,
            0.6035945467135813,
            0.6115047204792506,
        ],
        (("water_sim_cases", "BGW_1500"), "Water recovery"): [
            50.0,
            51.0,
            52.0,
            53.0,
            54.0,
            55.00000000000001,
            56.00000000000001,
            57.00000000000001,
            57.99999999999999,
            59.0,
            60.0,
            61.0,
            62.0,
            63.0,
            64.0,
            65.0,
            66.0,
            67.0,
            68.0,
            69.0,
            70.0,
            71.0,
            72.0,
            73.0,
            74.0,
            75.0,
            76.0,
            77.0,
            78.0,
            79.0,
            80.0,
            81.0,
            82.0,
            83.0,
            84.00000000000001,
            85.00000000000001,
            86.0,
            87.0,
            88.0,
            89.0,
            90.0,
        ],
        (("water_sim_cases", "BGW_1500"), "LCOW"): [
            1.2897288678212604,
            1.2806863525540808,
            1.2717415644275678,
            1.262896567541882,
            1.2541529125124087,
            1.2455115074501375,
            1.2369728532616766,
            1.2285372121110472,
            1.2202046204490058,
            1.2119749675001525,
            1.2038476345940883,
            1.1958220314750765,
            1.1878975327282317,
            1.1800733802502388,
            1.1723487015797538,
            1.1647226487526112,
            1.1571944716545146,
            1.149763162565157,
            1.1424279158726223,
            1.1351879873609536,
            1.1280427539344724,
            1.120991784054283,
            1.1140348086173977,
            1.1071716240190974,
            1.1004024510994674,
            1.0937278906488748,
            1.087149095127625,
            1.080667568566336,
            1.0742856935484755,
            1.068006915627642,
            1.0618358404174728,
            1.0557787143160906,
            1.0498441891723418,
            1.04404382259755,
            1.0383935080782194,
            1.0329152008153477,
            1.027640233768878,
            1.0227846473209905,
            1.0186137434189173,
            1.0153483667440018,
            1.0133161345714359,
        ],
        (("water_sim_cases", "BGW_500"), "Water recovery"): [
            50.0,
            51.0,
            52.0,
            53.0,
            54.0,
            55.00000000000001,
            56.00000000000001,
            57.00000000000001,
            57.99999999999999,
            59.0,
            60.0,
            61.0,
            62.0,
            63.0,
            64.0,
            65.0,
            66.0,
            67.0,
            68.0,
            69.0,
            70.0,
            71.0,
            72.0,
            73.0,
            74.0,
            75.0,
            76.0,
            77.0,
            78.0,
            79.0,
            80.0,
            81.0,
            82.0,
            83.0,
            84.00000000000001,
            85.00000000000001,
            86.0,
            87.0,
            88.0,
            89.0,
            90.0,
        ],
        (("water_sim_cases", "BGW_500"), "LCOW"): [
            0.22720948732414264,
            0.22469213055835985,
            0.22227436294713063,
            0.21995128146941093,
            0.21771837086766743,
            0.21557147098758364,
            0.21350677103454663,
            0.21152068981492575,
            0.20961004735951264,
            0.20780193681051845,
            0.2064093245659443,
            0.2058174447902272,
            0.20663656964454505,
            0.20984651901919785,
            0.21690066195194918,
            0.2297745889450219,
            0.25271711135187447,
            0.2821448569314892,
            0.29846921096028317,
            0.31799991486797463,
            0.3404308844132664,
            0.3588947303308141,
            0.3747168927997175,
            0.38856243593896195,
            0.40086826366650424,
            0.41191647637618173,
            0.4219061859585433,
            0.43098703036989616,
            0.43927567472898205,
            0.4468671769563794,
            0.4538413897955871,
            0.46026699155220924,
            0.4662046867923622,
            0.4717105700625011,
            0.4768378234303529,
            0.4816396308261248,
            0.48627076067976766,
            0.4909259033957353,
            0.49576467225845894,
            0.50099822544805,
            0.5069200683439524,
        ],
        (("water_sim_cases", "SW_HPRO"), "Water recovery"): [
            50.0,
            51.0,
            52.0,
            53.0,
            54.0,
            55.00000000000001,
            56.00000000000001,
            57.00000000000001,
            57.99999999999999,
            59.0,
            60.0,
            61.0,
            62.0,
            63.0,
            64.0,
            65.0,
            66.0,
            67.0,
            68.0,
            69.0,
            70.0,
            71.0,
            72.0,
            73.0,
            74.0,
            75.0,
            76.0,
            77.0,
            78.0,
            79.0,
            80.0,
            81.0,
            82.0,
            83.0,
            84.00000000000001,
            85.00000000000001,
            86.0,
            87.0,
            88.0,
            89.0,
            90.0,
        ],
        (("water_sim_cases", "SW_HPRO"), "LCOW"): [
            0.45582487885144163,
            0.452871884931901,
            0.4502143688307725,
            0.44784953431810093,
            0.4457763373813818,
            0.4439955000545038,
            0.4425096838197294,
            0.44132353904164023,
            0.4404438639957663,
            0.439879879912286,
            0.43964341039444005,
            0.4397492384866041,
            0.44021547625353563,
            0.4410640385636979,
            0.4423212204009909,
            0.44396343965811735,
            0.4458390719026851,
            0.4479715245877513,
            0.45039954964271356,
            0.45316390479972984,
            0.45630939891452477,
            0.4598867383689785,
            0.46395439446303743,
            0.46858086888312955,
            0.47796222073602423,
            0.5752975539501625,
            0.6410758298297797,
            0.7325600376373628,
            0.8092667742898411,
            0.8785773964979905,
            0.9435097140978818,
            1.0058242326002789,
            1.0668362677534988,
            1.1281616361221578,
            1.1913600322532691,
            1.258307792187941,
            1.3315671375584053,
            None,
            None,
            None,
            None,
        ],
        (("water_sim_cases", "SW_RO"), "Water recovery"): [
            50.0,
            51.0,
            52.0,
            53.0,
            54.0,
            55.00000000000001,
            56.00000000000001,
            57.00000000000001,
            57.99999999999999,
            59.0,
            60.0,
            61.0,
            62.0,
            63.0,
            64.0,
            65.0,
            66.0,
            67.0,
            68.0,
            69.0,
            70.0,
            71.0,
            72.0,
            73.0,
            74.0,
            75.0,
            76.0,
            77.0,
            78.0,
            79.0,
            80.0,
            81.0,
            82.0,
            83.0,
            84.00000000000001,
            85.00000000000001,
            86.0,
            87.0,
            88.0,
            89.0,
            90.0,
        ],
        (("water_sim_cases", "SW_RO"), "LCOW"): [
            0.4185786768301935,
            0.4178960751709397,
            0.4175088476069979,
            0.4174234032864734,
            0.4176482153053023,
            0.4181939103136492,
            0.419073488118423,
            0.4203025325131128,
            0.42189949157399936,
            0.4238860056279791,
            0.42628729741753624,
            0.4291326388908964,
            0.432455914974965,
            0.43629629796526515,
            0.44069900790774386,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
        ],
    }
    for key in data_manager:
        #     test_data[key] = data_manager[key].data.tolist()
        solved_data = data_manager[key].data
        for i, val in enumerate(test_data[key]):
            if val is None:
                assert solved_data[i] != solved_data[i]
            else:
                assert val == pytest.approx(solved_data[i], rel=1e-5)
    # print(test_data)
