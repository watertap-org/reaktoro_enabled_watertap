import pytest

from reaktoro_enabled_watertap.analysis_scripts.softening_acid_ro.data_generation import (
    treatment_sweep,
    validation_sweep,
    stability_sweep,
)
from reaktoro_enabled_watertap.utils.report_util import get_lib_path

from psPlotKit.data_manager.ps_data_manager import psDataManager

import os


@pytest.mark.component
def test_treatment_sweep():
    work_path = get_lib_path()
    filename = str(
        work_path
        / "analysis_scripts/softening_acid_ro/data_generation/output/treatment_lime_soda_ash_hcl_h2so4_sweep_analysisType_treatment_sweep.h5"
    )
    if os.path.exists(filename):
        os.remove(filename)

    treatment_sweep.main()

    data_manager = psDataManager(
        filename,
    )
    data_manager.register_data_key(
        file_key="fs.water_recovery", return_key="Water recovery", units="%"
    )
    data_manager.register_data_key(file_key="fs.costing.LCOW", return_key="LCOW")
    data_manager.load_data()
    data_manager.display()
    test_data = {
        (("water_sim_cases", "BGW"), "Water recovery"): [
            50.0,
            51.0,
            52.0,
            53.0,
            54.0,
            55.00000000000001,
            56.00000000000001,
            57.00000000000001,
            57.99999999999999,
            59.0,
            60.0,
            61.0,
            62.0,
            63.0,
            64.0,
            65.0,
            66.0,
            67.0,
            68.0,
            69.0,
            70.0,
            71.0,
            72.0,
            73.0,
            74.0,
            75.0,
            76.0,
            77.0,
            78.0,
            79.0,
            80.0,
            81.0,
            82.0,
            83.0,
            84.00000000000001,
            85.00000000000001,
            86.0,
            87.0,
            88.0,
            89.0,
            90.0,
        ],
        (("water_sim_cases", "BGW"), "LCOW"): [
            0.2156580962865019,
            0.21387009029098486,
            0.21216348483174272,
            0.21053477137681467,
            0.2089807471230017,
            0.2074984977525569,
            0.20609010363653318,
            0.2052136559812072,
            0.20557655932738234,
            0.2080027071762921,
            0.2137170875121642,
            0.2244291232667974,
            0.242504651308636,
            0.2634390826806359,
            0.3052568969857765,
            0.37412187090867427,
            0.4085557531125057,
            0.42799487939617037,
            0.4406452153958282,
            0.4507702996921865,
            0.45905341150311757,
            0.4659609149424136,
            0.4718528978847185,
            0.4770691609287608,
            0.48311607154524977,
            0.49522613994292386,
            0.5069541885724004,
            0.5176500865617573,
            0.5274380373316803,
            0.5364226984945342,
            0.5446938988874132,
            0.5523318112538624,
            0.5594105404819805,
            0.5660006481782034,
            0.572238375384632,
            0.5782733756081037,
            0.5842388887239114,
            0.590297201724645,
            0.5966561967130112,
            0.6035945467135813,
            0.6115047204792506,
        ],
        (("water_sim_cases", "BGW_1500"), "Water recovery"): [
            50.0,
            51.0,
            52.0,
            53.0,
            54.0,
            55.00000000000001,
            56.00000000000001,
            57.00000000000001,
            57.99999999999999,
            59.0,
            60.0,
            61.0,
            62.0,
            63.0,
            64.0,
            65.0,
            66.0,
            67.0,
            68.0,
            69.0,
            70.0,
            71.0,
            72.0,
            73.0,
            74.0,
            75.0,
            76.0,
            77.0,
            78.0,
            79.0,
            80.0,
            81.0,
            82.0,
            83.0,
            84.00000000000001,
            85.00000000000001,
            86.0,
            87.0,
            88.0,
            89.0,
            90.0,
        ],
        (("water_sim_cases", "BGW_1500"), "LCOW"): [
            1.2897288678212604,
            1.2806863525540808,
            1.2717415644275678,
            1.262896567541882,
            1.2541529125124087,
            1.2455115074501375,
            1.2369728532616766,
            1.2285372121110472,
            1.2202046204490058,
            1.2119749675001525,
            1.2038476345940883,
            1.1958220314750765,
            1.1878975327282317,
            1.1800733802502388,
            1.1723487015797538,
            1.1647226487526112,
            1.1571944716545146,
            1.149763162565157,
            1.1424279158726223,
            1.1351879873609536,
            1.1280427539344724,
            1.120991784054283,
            1.1140348086173977,
            1.1071716240190974,
            1.1004024510994674,
            1.0937278906488748,
            1.087149095127625,
            1.080667568566336,
            1.0742856935484755,
            1.068006915627642,
            1.0618358404174728,
            1.0557787143160906,
            1.0498441891723418,
            1.04404382259755,
            1.0383935080782194,
            1.0329152008153477,
            1.027640233768878,
            1.0227846473209905,
            1.0186137434189173,
            1.0153483667440018,
            1.0133161345714359,
        ],
        (("water_sim_cases", "BGW_500"), "Water recovery"): [
            50.0,
            51.0,
            52.0,
            53.0,
            54.0,
            55.00000000000001,
            56.00000000000001,
            57.00000000000001,
            57.99999999999999,
            59.0,
            60.0,
            61.0,
            62.0,
            63.0,
            64.0,
            65.0,
            66.0,
            67.0,
            68.0,
            69.0,
            70.0,
            71.0,
            72.0,
            73.0,
            74.0,
            75.0,
            76.0,
            77.0,
            78.0,
            79.0,
            80.0,
            81.0,
            82.0,
            83.0,
            84.00000000000001,
            85.00000000000001,
            86.0,
            87.0,
            88.0,
            89.0,
            90.0,
        ],
        (("water_sim_cases", "BGW_500"), "LCOW"): [
            0.22720948732414264,
            0.22469213055835985,
            0.22227436294713063,
            0.21995128146941093,
            0.21771837086766743,
            0.21557147098758364,
            0.21350677103454663,
            0.21152068981492575,
            0.20961004735951264,
            0.20780193681051845,
            0.2064093245659443,
            0.2058174447902272,
            0.20663656964454505,
            0.20984651901919785,
            0.21690066195194918,
            0.2297745889450219,
            0.25271711135187447,
            0.2821448569314892,
            0.29846921096028317,
            0.31799991486797463,
            0.3404308844132664,
            0.3588947303308141,
            0.3747168927997175,
            0.38856243593896195,
            0.40086826366650424,
            0.41191647637618173,
            0.4219061859585433,
            0.43098703036989616,
            0.43927567472898205,
            0.4468671769563794,
            0.4538413897955871,
            0.46026699155220924,
            0.4662046867923622,
            0.4717105700625011,
            0.4768378234303529,
            0.4816396308261248,
            0.48627076067976766,
            0.4909259033957353,
            0.49576467225845894,
            0.50099822544805,
            0.5069200683439524,
        ],
        (("water_sim_cases", "SW_HPRO"), "Water recovery"): [
            50.0,
            51.0,
            52.0,
            53.0,
            54.0,
            55.00000000000001,
            56.00000000000001,
            57.00000000000001,
            57.99999999999999,
            59.0,
            60.0,
            61.0,
            62.0,
            63.0,
            64.0,
            65.0,
            66.0,
            67.0,
            68.0,
            69.0,
            70.0,
            71.0,
            72.0,
            73.0,
            74.0,
            75.0,
            76.0,
            77.0,
            78.0,
            79.0,
            80.0,
            81.0,
            82.0,
            83.0,
            84.00000000000001,
            85.00000000000001,
            86.0,
            87.0,
            88.0,
            89.0,
            90.0,
        ],
        (("water_sim_cases", "SW_HPRO"), "LCOW"): [
            0.45582487885144163,
            0.452871884931901,
            0.4502143688307725,
            0.44784953431810093,
            0.4457763373813818,
            0.4439955000545038,
            0.4425096838197294,
            0.44132353904164023,
            0.4404438639957663,
            0.439879879912286,
            0.43964341039444005,
            0.4397492384866041,
            0.44021547625353563,
            0.4410640385636979,
            0.4423212204009909,
            0.44396343965811735,
            0.4458390719026851,
            0.4479715245877513,
            0.45039954964271356,
            0.45316390479972984,
            0.45630939891452477,
            0.4598867383689785,
            0.46395439446303743,
            0.46858086888312955,
            0.47796222073602423,
            0.5752975539501625,
            0.6410758298297797,
            0.7325600376373628,
            0.8092667742898411,
            0.8785773964979905,
            0.9435097140978818,
            1.0058242326002789,
            1.0668362677534988,
            1.1281616361221578,
            1.1913600322532691,
            1.258307792187941,
            1.3315671375584053,
            None,
            None,
            None,
            None,
        ],
        (("water_sim_cases", "SW_RO"), "Water recovery"): [
            50.0,
            51.0,
            52.0,
            53.0,
            54.0,
            55.00000000000001,
            56.00000000000001,
            57.00000000000001,
            57.99999999999999,
            59.0,
            60.0,
            61.0,
            62.0,
            63.0,
            64.0,
            65.0,
            66.0,
            67.0,
            68.0,
            69.0,
            70.0,
            71.0,
            72.0,
            73.0,
            74.0,
            75.0,
            76.0,
            77.0,
            78.0,
            79.0,
            80.0,
            81.0,
            82.0,
            83.0,
            84.00000000000001,
            85.00000000000001,
            86.0,
            87.0,
            88.0,
            89.0,
            90.0,
        ],
        (("water_sim_cases", "SW_RO"), "LCOW"): [
            0.4185786768301935,
            0.4178960751709397,
            0.4175088476069979,
            0.4174234032864734,
            0.4176482153053023,
            0.4181939103136492,
            0.419073488118423,
            0.4203025325131128,
            0.42189949157399936,
            0.4238860056279791,
            0.42628729741753624,
            0.4291326388908964,
            0.432455914974965,
            0.43629629796526515,
            0.44069900790774386,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
        ],
    }
    for key in data_manager:
        #     test_data[key] = data_manager[key].data.tolist()
        solved_data = data_manager[key].data
        for i, val in enumerate(test_data[key]):
            if val is None:
                assert solved_data[i] != solved_data[i]
            else:
                assert val == pytest.approx(solved_data[i], rel=1e-5)
    # print(test_data)


@pytest.mark.component
def test_validation_sweep():

    work_path = get_lib_path()
    filename = str(
        work_path
        / "analysis_scripts/softening_acid_ro/data_generation/output/validation_soda_ash_hcl_h2so4_sweep_analysisType_validation_sweep.h5"
    )
    if os.path.exists(filename):
        os.remove(filename)

    validation_sweep.main()

    data_manager = psDataManager(
        filename,
    )
    data_manager.register_data_key(
        file_key="fs.water_recovery", return_key="Water recovery", units="%"
    )
    data_manager.register_data_key(file_key="fs.costing.LCOW", return_key="LCOW")
    data_manager.load_data()
    data_manager.display()
    test_data = {
        (
            ("acidification_reagents", "H2SO4"),
            ("water_sim_cases", "BGW"),
            "Water recovery",
        ): [
            50.0,
            51.0,
            52.0,
            53.0,
            54.0,
            55.00000000000001,
            56.00000000000001,
            57.00000000000001,
            57.99999999999999,
            59.0,
            60.0,
            61.0,
            62.0,
            63.0,
            64.0,
            65.0,
            66.0,
            67.0,
            68.0,
            69.0,
            70.0,
            71.0,
            72.0,
            73.0,
            74.0,
            75.0,
            76.0,
            77.0,
            78.0,
            79.0,
            80.0,
            81.0,
            82.0,
            83.0,
            84.00000000000001,
            85.00000000000001,
            86.0,
            87.0,
            88.0,
            89.0,
            90.0,
        ],
        (("acidification_reagents", "H2SO4"), ("water_sim_cases", "BGW"), "LCOW"): [
            0.21508853259451272,
            0.21331171445143293,
            0.21161586998125714,
            0.2099975117244963,
            0.2084534594001307,
            0.20698081964333548,
            0.20558173266660382,
            0.204714728250145,
            0.20508713862265798,
            0.20752306622925712,
            0.2132477469981233,
            0.22397086574100852,
            0.24224820265669988,
            0.3201103454409547,
            0.37567708258055943,
            0.4159771418413422,
            0.44885745196181853,
            0.47691017328029134,
            0.5013495582276617,
            0.5228762874295494,
            0.5421038645092853,
            0.5594239287068264,
            0.5750874427832521,
            0.5893390868890911,
            0.6023701915200776,
            0.6143323744931141,
            0.6253509954406089,
            0.6355324392384182,
            0.6449685841071936,
            0.6537410264520398,
            0.6619249438877567,
            0.6695910367606721,
            0.6768283800924958,
            0.6837735591023623,
            0.6905338279655644,
            0.6972305078341047,
            0.7040082810317484,
            0.7110483027374812,
            0.7185859587319213,
            0.7269404062459844,
            0.7365637649360409,
        ],
        (
            ("acidification_reagents", "H2SO4"),
            ("water_sim_cases", "SW_HPRO"),
            "Water recovery",
        ): [
            50.0,
            51.0,
            52.0,
            53.0,
            54.0,
            55.00000000000001,
            56.00000000000001,
            57.00000000000001,
            57.99999999999999,
            59.0,
            60.0,
            61.0,
            62.0,
            63.0,
            64.0,
            65.0,
            66.0,
            67.0,
            68.0,
            69.0,
            70.0,
            71.0,
            72.0,
            73.0,
            74.0,
            75.0,
            76.0,
            77.0,
            78.0,
            79.0,
            80.0,
            81.0,
            82.0,
            83.0,
            84.00000000000001,
            85.00000000000001,
            86.0,
            87.0,
            88.0,
            89.0,
            90.0,
        ],
        (("acidification_reagents", "H2SO4"), ("water_sim_cases", "SW_HPRO"), "LCOW"): [
            0.45525517161986206,
            0.45231337048966797,
            0.44966662719247436,
            0.4473181341158099,
            0.4452489260764711,
            0.4434777201509395,
            0.4420011755699883,
            0.44082397996016087,
            0.4399529580563569,
            0.4393973228420021,
            0.43917498263383825,
            0.4392825720800019,
            0.4397563734377149,
            0.44061226118562813,
            0.4418765464182633,
            0.4435256413815541,
            0.44540794675866424,
            0.4475468756450288,
            0.4499811888522449,
            0.45275165252518523,
            0.45590308346682046,
            0.45948619238559735,
            0.4635594673072848,
            0.46819140710700174,
            0.47758376514444617,
            0.6200802520614351,
            0.7182722709396406,
            0.7974044450085487,
            0.8677314238000166,
            0.9328565272575651,
            0.9947114126197759,
            1.0545904038035905,
            1.113581518929983,
            1.1731870993024884,
            1.2348861096660084,
            1.3004914533701784,
            1.3724995859630582,
            None,
            None,
            None,
            None,
        ],
        (
            ("acidification_reagents", "H2SO4"),
            ("water_sim_cases", "SW_RO"),
            "Water recovery",
        ): [
            50.0,
            51.0,
            52.0,
            53.0,
            54.0,
            55.00000000000001,
            56.00000000000001,
            57.00000000000001,
            57.99999999999999,
            59.0,
            60.0,
            61.0,
            62.0,
            63.0,
            64.0,
            65.0,
            66.0,
            67.0,
            68.0,
            69.0,
            70.0,
            71.0,
            72.0,
            73.0,
            74.0,
            75.0,
            76.0,
            77.0,
            78.0,
            79.0,
            80.0,
            81.0,
            82.0,
            83.0,
            84.00000000000001,
            85.00000000000001,
            86.0,
            87.0,
            88.0,
            89.0,
            90.0,
        ],
        (("acidification_reagents", "H2SO4"), ("water_sim_cases", "SW_RO"), "LCOW"): [
            0.4180089844056519,
            0.4173375855628894,
            0.41696111854670503,
            0.4168860424678133,
            0.4171208370221603,
            0.41767614662410835,
            0.4185650001276042,
            0.419802999435491,
            0.4214085999150694,
            0.4234034672133017,
            0.425812838773262,
            0.42866599391135835,
            0.43199683362283775,
            0.4358445358973336,
            0.4402543513184883,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
        ],
        (
            ("acidification_reagents", "HCl"),
            ("water_sim_cases", "BGW"),
            "Water recovery",
        ): [
            50.0,
            51.0,
            52.0,
            53.0,
            54.0,
            55.00000000000001,
            56.00000000000001,
            57.00000000000001,
            57.99999999999999,
            59.0,
            60.0,
            61.0,
            62.0,
            63.0,
            64.0,
            65.0,
            66.0,
            67.0,
            68.0,
            69.0,
            70.0,
            71.0,
            72.0,
            73.0,
            74.0,
            75.0,
            76.0,
            77.0,
            78.0,
            79.0,
            80.0,
            81.0,
            82.0,
            83.0,
            84.00000000000001,
            85.00000000000001,
            86.0,
            87.0,
            88.0,
            89.0,
            90.0,
        ],
        (("acidification_reagents", "HCl"), ("water_sim_cases", "BGW"), "LCOW"): [
            0.2506221262300681,
            0.24910771909044552,
            0.24768204420152182,
            0.24634168265435255,
            0.2450835162259464,
            0.243904722854937,
            0.24280276841161225,
            0.2417753800775518,
            0.24082052636049137,
            0.23998385200851244,
            0.24039225463192826,
            0.24334302466835528,
            0.25033808927735035,
            0.2634548328918324,
            0.30522828966989535,
            0.3813334309027593,
            0.42677353528052675,
            0.4626268102250411,
            0.4928369676398769,
            0.5191015312899686,
            0.5423404878056954,
            0.5630929515816764,
            0.5818225342611391,
            0.5988134283419557,
            0.6143245421661987,
            0.6285665681499448,
            0.6417056751361928,
            0.6538778238447546,
            0.6651980043522325,
            0.6757649760496776,
            0.685669996943522,
            0.6950334791563462,
            0.7039639794324528,
            0.7125659494317955,
            0.720952227869965,
            0.7292512364702206,
            0.7376148450427674,
            0.746231393330837,
            0.7553435601584053,
            0.7652785314003092,
            0.7764968955211953,
        ],
        (
            ("acidification_reagents", "HCl"),
            ("water_sim_cases", "SW_HPRO"),
            "Water recovery",
        ): [
            50.0,
            51.0,
            52.0,
            53.0,
            54.0,
            55.00000000000001,
            56.00000000000001,
            57.00000000000001,
            57.99999999999999,
            59.0,
            60.0,
            61.0,
            62.0,
            63.0,
            64.0,
            65.0,
            66.0,
            67.0,
            68.0,
            69.0,
            70.0,
            71.0,
            72.0,
            73.0,
            74.0,
            75.0,
            76.0,
            77.0,
            78.0,
            79.0,
            80.0,
            81.0,
            82.0,
            83.0,
            84.00000000000001,
            85.00000000000001,
            86.0,
            87.0,
            88.0,
            89.0,
            90.0,
        ],
        (("acidification_reagents", "HCl"), ("water_sim_cases", "SW_HPRO"), "LCOW"): [
            0.460247399834088,
            0.4574015578525132,
            0.4548557870410592,
            0.45260766068958164,
            0.4506565004169325,
            0.44900348131693896,
            0.44765169017044126,
            0.4466062796557736,
            0.44587460443203464,
            0.4454724952734889,
            0.44539432448144217,
            0.44567372827311036,
            0.44632358513898807,
            0.44736668055010553,
            0.44883030888792474,
            0.45069440307487485,
            0.45280409413870165,
            0.4551829291254088,
            0.45787187072259083,
            0.46091388353129165,
            0.4643561141992494,
            0.4682518472133811,
            0.4726624280334625,
            0.4776595366139378,
            0.4853817032677951,
            0.617236025395561,
            0.7197691980754589,
            0.8007597952290406,
            0.8723601789966726,
            0.9385113192195244,
            1.0012639193529036,
            1.0619680670517901,
            1.1217387591189325,
            1.1820927132056143,
            1.2445234200654183,
            1.3108489644427226,
            1.3835628467008538,
            None,
            None,
            None,
            None,
        ],
        (
            ("acidification_reagents", "HCl"),
            ("water_sim_cases", "SW_RO"),
            "Water recovery",
        ): [
            50.0,
            51.0,
            52.0,
            53.0,
            54.0,
            55.00000000000001,
            56.00000000000001,
            57.00000000000001,
            57.99999999999999,
            59.0,
            60.0,
            61.0,
            62.0,
            63.0,
            64.0,
            65.0,
            66.0,
            67.0,
            68.0,
            69.0,
            70.0,
            71.0,
            72.0,
            73.0,
            74.0,
            75.0,
            76.0,
            77.0,
            78.0,
            79.0,
            80.0,
            81.0,
            82.0,
            83.0,
            84.00000000000001,
            85.00000000000001,
            86.0,
            87.0,
            88.0,
            89.0,
            90.0,
        ],
        (("acidification_reagents", "HCl"), ("water_sim_cases", "SW_RO"), "LCOW"): [
            0.42294573027738347,
            0.4223582880866209,
            0.4220703189709755,
            0.42208860777565466,
            0.42242198124633196,
            0.4230814866214094,
            0.4240805909493939,
            0.4254353794651364,
            0.42716484335795696,
            0.4292950198047097,
            0.4318404400671629,
            0.43484247116750546,
            0.4383320343425597,
            0.44234922131253956,
            0.44694029228523124,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
            None,
        ],
    }
    for key in data_manager:
        #     test_data[key] = data_manager[key].data.tolist()
        solved_data = data_manager[key].data
        for i, val in enumerate(test_data[key]):
            if val is None:
                assert solved_data[i] != solved_data[i]
            else:
                assert val == pytest.approx(solved_data[i], rel=1e-5)
